from django.shortcuts import render
from django.db.models import Sum, Count
from django.utils import timezone
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from accounts.models import User
from locations.models import Branch
from orders.models import Order
from .models import Payment
from rest_framework.authentication import SessionAuthentication
from rest_framework.permissions import IsAuthenticated
from branch_management.models import BranchManager
from subscriptions.models import CustomerSubscription

class AdminOverviewView(APIView):
    authentication_classes = []  # TODO: secure with proper auth

    def get(self, request):
        total_revenue = Payment.objects.filter(payment_status="paid").aggregate(
            total=Sum("amount")
        )["total"] or 0

        active_branches = Branch.objects.filter(is_active=True).count()
        users_total = User.objects.count()
        orders_total = Order.objects.count()

        perf_qs = (
            Order.objects.values("branch__branch_name")
            .annotate(total=Count("id"))
            .order_by("-total")[:10]
        )
        branch_performance = [p["total"] for p in perf_qs] or [60, 40, 80, 50, 70, 90, 55, 35, 75, 65]

        return Response(
            {
                "weeklyRevenue": float(total_revenue),
                "activeBranches": active_branches,
                "onlineUsers": users_total,
                "ordersTotal": orders_total,
                "branchPerformance": branch_performance,
                "traffic": {"search": 40, "direct": 30, "social": 30},
            },
            status=status.HTTP_200_OK,
        )

class AdminPaymentsView(APIView):
    authentication_classes = []  # TODO: secure with proper auth

    def get(self, request):
        payments = Payment.objects.select_related("user").order_by("-due_date")[:200]
        data = [
            {
                "id": p.id,
                "user": p.user.full_name,
                "type": p.payment_type,
                "amount": float(p.amount),
                "status": p.payment_status,
            }
            for p in payments
        ]
        return Response(data, status=status.HTTP_200_OK)

class AdminAnalyticsView(APIView):
    authentication_classes = []  # TODO: secure with proper auth

    def get(self, request):
        now = timezone.now()
        monthly_revenue = Payment.objects.filter(
            payment_status="paid",
            payment_date__year=now.year,
            payment_date__month=now.month,
        ).aggregate(total=Sum("amount"))["total"] or 0

        return Response(
            {
                "totalOrders": Order.objects.count(),
                "monthlyRevenue": float(monthly_revenue),
                "activeBranches": Branch.objects.filter(is_active=True).count(),
                "usersTotal": User.objects.count(),
            },
            status=status.HTTP_200_OK,
        )

class CsrfExemptSessionAuthentication(SessionAuthentication):
    def enforce_csrf(self, request):
        return

def _get_branch(request):
    if request.user and request.user.is_authenticated:
        try:
            return BranchManager.objects.select_related("branch").get(user=request.user).branch
        except BranchManager.DoesNotExist:
            pass
    branch_id = request.query_params.get("branch_id") or request.data.get("branch_id")
    if branch_id:
        try:
            return Branch.objects.get(id=branch_id)
        except Branch.DoesNotExist:
            return None
    return None

class ManagerMonthlyPaymentsView(APIView):
    authentication_classes = [CsrfExemptSessionAuthentication]
    permission_classes = [IsAuthenticated]

    def get(self, request):
        branch = _get_branch(request)
        if not branch:
            return Response({"detail": "branch not found"}, status=status.HTTP_400_BAD_REQUEST)

        user_ids = Order.objects.filter(
            branch=branch,
            order_type="monthly",
        ).values_list("user_id", flat=True).distinct()

        payments = Payment.objects.select_related(
            "user", "subscription", "subscription__plan"
        ).filter(
            payment_type="monthly",
            subscription__user_id__in=user_ids,
        ).order_by("-due_date")[:200]

        fines_qs = PaymentFine.objects.filter(payment__in=payments).order_by("payment_id", "-calculated_at")
        fine_map = {}
        for f in fines_qs:
            if f.payment_id not in fine_map:
                fine_map[f.payment_id] = {"fine_amount": float(f.fine_amount), "fine_days": f.fine_days}

        data = [
            {
                "id": p.id,
                "user": p.user.full_name,
                "plan": p.subscription.plan.name if p.subscription and p.subscription.plan else None,
                "amount": float(p.amount),
                "status": p.payment_status,
                "fine_amount": fine_map.get(p.id, {}).get("fine_amount"),
                "fine_days": fine_map.get(p.id, {}).get("fine_days"),
            }
            for p in payments
        ]
        return Response(data, status=status.HTTP_200_OK)

class CustomerPaymentsView(APIView):
    authentication_classes = [CsrfExemptSessionAuthentication]
    permission_classes = [IsAuthenticated]

    def get(self, request):
        payments = Payment.objects.filter(user=request.user).order_by("-payment_date")[:200]
        data = [
            {
                "id": p.id,
                "amount": float(p.amount),
                "payment_type": p.payment_type,
                "payment_status": p.payment_status,
                "payment_date": p.payment_date.isoformat() if p.payment_date else None,
                "fine_amount": getattr(getattr(p, "fine", None), "fine_amount", 0),
            }
            for p in payments
        ]
        return Response(data, status=status.HTTP_200_OK)